#!/bin/bash

set -eu

# Ensure nvidia support setup correctly #
if snapctl is-connected graphics-core22 ; then

    # Only set this up if the system has an nvidia card available #
    grep -Eq "^nvidia" /proc/modules || exit 0
    test -c /dev/nvidiactl || exit 0
    echo "NVIDIA detected"

    # Ensure the layouts dir for /etc/cdi exists #
    mkdir -p "$SNAP_DATA/etc/cdi"

    # Generate the CDI config #
    "${SNAP}/usr/bin/nvidia-ctk" cdi generate --nvidia-ctk-path "${SNAP}/usr/bin/nvidia-ctk" --output="${SNAP_DATA}/etc/cdi/nvidia.yaml"

    # Generate the dockerd runtime config #
    "${SNAP}/usr/bin/nvidia-ctk" runtime configure --runtime=docker --runtime-path "${SNAP}/usr/bin/nvidia-ctk" --config "${SNAP_DATA}/config/daemon.json"

fi
